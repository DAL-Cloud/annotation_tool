<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Highlight & Annotation Tool</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Icon Components
        const Upload = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{display: 'inline-block', verticalAlign: 'middle', marginRight: '8px'}}>
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
            </svg>
        );
        
        const Download = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{display: 'inline-block', verticalAlign: 'middle'}}>
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
            </svg>
        );
        
        const BookOpen = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{display: 'inline-block', verticalAlign: 'middle', marginRight: '8px'}}>
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2zM22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
            </svg>
        );
        
        const Lightbulb = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{display: 'inline-block', verticalAlign: 'middle'}}>
                <path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5M9 18h6M10 22h4"/>
            </svg>
        );
        
        const CheckCircle = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{display: 'inline-block', verticalAlign: 'middle'}}>
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14M22 4 12 14.01l-3-3"/>
            </svg>
        );
        
        const AlertCircle = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{display: 'inline-block', verticalAlign: 'middle'}}>
                <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
        );
        
        const FileText = ({ size = 48 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{margin: '0 auto'}}>
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
            </svg>
        );
        
        const Users = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{display: 'inline-block', verticalAlign: 'middle', marginRight: '8px'}}>
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75M13 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0z"/>
            </svg>
        );
        
        const Sparkles = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{display: 'inline-block', verticalAlign: 'middle'}}>
                <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3zM5 3v4M3 5h4M19 17v4M17 19h4"/>
            </svg>
        );

        function PDFHighlightTool() {
            const [activeTab, setActiveTab] = useState('setup');
            const [highlights, setHighlights] = useState([]);
            const [feedback, setFeedback] = useState([]);
            const [articleText, setArticleText] = useState('');
            const [articleTitle, setArticleTitle] = useState('');
            const [pastedText, setPastedText] = useState('');
            
            const [numCollaborators, setNumCollaborators] = useState(2);
            const [collaboratorNames, setCollaboratorNames] = useState(['Student 1', 'Student 2']);
            const [currentCollaborator, setCurrentCollaborator] = useState(0);
            const [allHighlights, setAllHighlights] = useState({});
            const [compiledSummary, setCompiledSummary] = useState('');

            useEffect(() => {
                if (window.pdfjsLib) {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                }
                
                const savedState = loadFromMemory();
                if (savedState) {
                    setArticleText(savedState.articleText || '');
                    setArticleTitle(savedState.articleTitle || '');
                    setNumCollaborators(savedState.numCollaborators || 2);
                    setCollaboratorNames(savedState.collaboratorNames || ['Student 1', 'Student 2']);
                    setAllHighlights(savedState.allHighlights || {});
                    setCurrentCollaborator(savedState.currentCollaborator || 0);
                    setCompiledSummary(savedState.compiledSummary || '');
                    
                    if (savedState.articleText) {
                        setActiveTab('practice');
                    }
                }
            }, []);

            useEffect(() => {
                const stateToSave = {
                    articleText,
                    articleTitle,
                    numCollaborators,
                    collaboratorNames,
                    allHighlights,
                    currentCollaborator,
                    compiledSummary
                };
                saveToMemory(stateToSave);
            }, [articleText, articleTitle, numCollaborators, collaboratorNames, allHighlights, currentCollaborator, compiledSummary]);

            const saveToMemory = (state) => {
                try {
                    window._highlightToolState = JSON.stringify(state);
                } catch (error) {
                    console.error('Error saving state:', error);
                }
            };

            const loadFromMemory = () => {
                try {
                    const data = window._highlightToolState;
                    if (data) return JSON.parse(data);
                } catch (error) {
                    console.error('Error loading state:', error);
                }
                return null;
            };

            const handleNumCollaboratorsChange = (num) => {
                setNumCollaborators(num);
                const names = Array(num).fill(0).map((_, i) => `Student ${i + 1}`);
                setCollaboratorNames(names);
                
                const highlightsObj = {};
                names.forEach(name => {
                    highlightsObj[name] = [];
                });
                setAllHighlights(highlightsObj);
            };

            const handleCollaboratorNameChange = (index, name) => {
                const newNames = [...collaboratorNames];
                const oldName = newNames[index];
                newNames[index] = name;
                setCollaboratorNames(newNames);
                
                const newHighlights = { ...allHighlights };
                if (oldName in newHighlights) {
                    newHighlights[name] = newHighlights[oldName];
                    delete newHighlights[oldName];
                    setAllHighlights(newHighlights);
                }
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const fileName = file.name.replace(/\.[^/.]+$/, "");
                setArticleTitle(fileName);

                try {
                    if (file.type === 'text/plain') {
                        const text = await file.text();
                        setArticleText(text);
                        setActiveTab('practice');
                    } else if (file.type === 'application/pdf') {
                        const pdfjsLib = window.pdfjsLib;
                        if (!pdfjsLib) {
                            alert('PDF support is loading. Please try again.');
                            return;
                        }
                        
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        
                        let fullText = '';
                        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                            const page = await pdf.getPage(pageNum);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += pageText + '\\n\\n';
                        }
                        
                        if (fullText.trim().length > 100) {
                            setArticleText(fullText.trim());
                            setActiveTab('practice');
                        } else {
                            alert('Could not extract text. Try copy/paste.');
                        }
                    } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        
                        if (result.value && result.value.length > 100) {
                            setArticleText(result.value);
                            setActiveTab('practice');
                        } else {
                            alert('Could not extract text from Word document.');
                        }
                    } else {
                        alert('Please upload .txt, .pdf, or .docx');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error reading file. Try .txt or copy/paste.');
                }
            };

            const handleManualInput = () => {
                if (pastedText.trim().length > 100) {
                    setArticleText(pastedText);
                    if (!articleTitle.trim()) {
                        setArticleTitle('My Article');
                    }
                    setActiveTab('practice');
                } else {
                    alert('Please enter at least 100 characters');
                }
            };

            const resetArticle = () => {
                if (confirm('Reset everything? All work will be lost.')) {
                    setArticleText('');
                    setArticleTitle('');
                    setPastedText('');
                    setHighlights([]);
                    setFeedback([]);
                    setAllHighlights({});
                    setCompiledSummary('');
                    setCurrentCollaborator(0);
                    setActiveTab('setup');
                    window._highlightToolState = null;
                }
            };

            const handleTextSelection = () => {
                const selection = window.getSelection();
                const selectedText = selection.toString().trim();
                
                if (selectedText && selectedText.length > 10) {
                    const collaboratorName = collaboratorNames[currentCollaborator];
                    const newHighlight = {
                        text: selectedText,
                        id: Date.now(),
                        annotation: '',
                        collaborator: collaboratorName
                    };
                    
                    setHighlights([...highlights, newHighlight]);
                    
                    const newAllHighlights = { ...allHighlights };
                    if (!newAllHighlights[collaboratorName]) {
                        newAllHighlights[collaboratorName] = [];
                    }
                    newAllHighlights[collaboratorName] = [...newAllHighlights[collaboratorName], newHighlight];
                    setAllHighlights(newAllHighlights);
                    
                    const feedbackResult = analyzeHighlight(selectedText);
                    setFeedback([...feedback, { id: newHighlight.id, ...feedbackResult }]);
                    
                    selection.removeAllRanges();
                }
            };

            const analyzeHighlight = (text) => {
                const keyTerms = ['climate', 'temperature', 'study', 'research', 'shows', 'evidence', 'impact', 'effect', 'cause', 'result', 'important', 'significant', 'major', 'key', 'critical', 'essential'];
                const hasKeyTerm = keyTerms.some(term => text.toLowerCase().includes(term));
                
                const hasVerb = /\\b(is|are|was|were|has|have|can|will|shows|presents|affects|demonstrates|indicates|suggests|reveals)\\b/i.test(text);
                const isSubstantial = text.split(' ').length >= 8;
                const isExample = /for example|such as|for instance|like/i.test(text);
                const isMinorDetail = text.split(' ').length < 5;
                
                if (isMinorDetail) {
                    return { type: 'warning', message: 'This highlight is short. Try a complete sentence.' };
                }
                if (isExample && !hasKeyTerm) {
                    return { type: 'caution', message: 'This is an example. Make sure it supports a key point.' };
                }
                if (!hasKeyTerm && !hasVerb) {
                    return { type: 'warning', message: 'May not be a key point. Look for main ideas.' };
                }
                if (hasKeyTerm && hasVerb && isSubstantial) {
                    return { type: 'success', message: 'Excellent! This captures an important point.' };
                }
                if (hasKeyTerm || (hasVerb && isSubstantial)) {
                    return { type: 'good', message: 'Good selection. Relevant information.' };
                }
                
                return { type: 'neutral', message: 'Consider if this is central to the argument.' };
            };

            const switchCollaborator = (index) => {
                const currentName = collaboratorNames[currentCollaborator];
                const newAllHighlights = { ...allHighlights };
                newAllHighlights[currentName] = highlights;
                setAllHighlights(newAllHighlights);
                
                setCurrentCollaborator(index);
                const newName = collaboratorNames[index];
                setHighlights(newAllHighlights[newName] || []);
                
                const newFeedback = (newAllHighlights[newName] || []).map(h => ({
                    id: h.id,
                    ...analyzeHighlight(h.text)
                }));
                setFeedback(newFeedback);
            };

            const updateAnnotation = (id, text) => {
                setHighlights(highlights.map(h => 
                    h.id === id ? { ...h, annotation: text } : h
                ));
            };

            const removeHighlight = (id) => {
                setHighlights(highlights.filter(h => h.id !== id));
                setFeedback(feedback.filter(f => f.id !== id));
            };

            const generateSummary = () => {
                let allHighlightsList = [];
                Object.keys(allHighlights).forEach(name => {
                    const collabHighlights = allHighlights[name] || [];
                    allHighlightsList = [...allHighlightsList, ...collabHighlights];
                });

                if (allHighlightsList.length === 0) {
                    alert('No highlights found.');
                    return;
                }

                let summary = `COLLABORATIVE SUMMARY\\n`;
                summary += `Article: ${articleTitle}\\n`;
                summary += `Total Collaborators: ${numCollaborators}\\n`;
                summary += `Total Highlights: ${allHighlightsList.length}\\n\\n`;
                summary += '='.repeat(60) + '\\n\\n';

                summary += 'KEY POINTS BY COLLABORATOR:\\n\\n';
                Object.keys(allHighlights).forEach((name) => {
                    const collabHighlights = allHighlights[name] || [];
                    if (collabHighlights.length > 0) {
                        summary += `${name} (${collabHighlights.length} highlights):\\n`;
                        collabHighlights.forEach((h, i) => {
                            summary += `  ${i + 1}. ${h.text}\\n`;
                            if (h.annotation) {
                                summary += `     Note: ${h.annotation}\\n`;
                            }
                        });
                        summary += '\\n';
                    }
                });

                summary += '='.repeat(60) + '\\n\\n';
                summary += 'SYNTHESIZED SUMMARY:\\n\\n';
                
                const uniqueHighlights = [];
                const seenTexts = new Set();
                
                allHighlightsList.forEach(h => {
                    const normalizedText = h.text.toLowerCase().trim();
                    if (!seenTexts.has(normalizedText)) {
                        seenTexts.add(normalizedText);
                        uniqueHighlights.push(h);
                    }
                });

                summary += `Based on ${numCollaborators} collaborators' analysis:\\n\\n`;
                uniqueHighlights.forEach((h, i) => {
                    summary += `${i + 1}. ${h.text}\\n\\n`;
                });

                summary += '\\n' + '='.repeat(60) + '\\n\\n';
                summary += 'COLLABORATIVE INSIGHTS:\\n\\n';
                
                const annotatedHighlights = allHighlightsList.filter(h => h.annotation && h.annotation.trim());
                if (annotatedHighlights.length > 0) {
                    annotatedHighlights.forEach(h => {
                        summary += `"${h.text}"\\n`;
                        summary += `— ${h.collaborator}: ${h.annotation}\\n\\n`;
                    });
                } else {
                    summary += 'No additional notes added.\\n\\n';
                }

                setCompiledSummary(summary);
                setActiveTab('summary');
            };

            const exportSummary = () => {
                if (!compiledSummary) {
                    alert('Generate summary first');
                    return;
                }
                
                const blob = new Blob([compiledSummary], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `collaborative-summary-${articleTitle.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const getFeedbackIcon = (type) => {
                const icons = {
                    success: <CheckCircle />,
                    good: <CheckCircle />,
                    warning: <AlertCircle />,
                    caution: <AlertCircle />
                };
                return icons[type] || <Lightbulb />;
            };

            const getFeedbackColor = (type) => {
                const colors = {
                    success: 'bg-green-50 border-green-500',
                    good: 'bg-blue-50 border-blue-500',
                    warning: 'bg-orange-50 border-orange-500',
                    caution: 'bg-yellow-50 border-yellow-500'
                };
                return colors[type] || 'bg-gray-50 border-gray-500';
            };

            const collaboratorColors = [
                { bg: 'bg-blue-100', border: 'border-blue-500', highlight: 'bg-blue-200', text: 'text-blue-900' },
                { bg: 'bg-green-100', border: 'border-green-500', highlight: 'bg-green-200', text: 'text-green-900' },
                { bg: 'bg-purple-100', border: 'border-purple-500', highlight: 'bg-purple-200', text: 'text-purple-900' },
                { bg: 'bg-orange-100', border: 'border-orange-500', highlight: 'bg-orange-200', text: 'text-orange-900' }
            ];

            const renderHighlightedText = () => {
                if (!articleText) return null;

                const allHighlightsList = [];
                Object.keys(allHighlights).forEach((name, collabIndex) => {
                    const collabHighlights = allHighlights[name] || [];
                    collabHighlights.forEach(h => {
                        allHighlightsList.push({
                            ...h,
                            collaboratorIndex: collabIndex,
                            collaboratorName: name
                        });
                    });
                });

                if (allHighlightsList.length === 0) {
                    return <div className="whitespace-pre-line text-gray-800">{articleText}</div>;
                }

                const highlightPositions = [];
                allHighlightsList.forEach(h => {
                    const index = articleText.indexOf(h.text);
                    if (index !== -1) {
                        highlightPositions.push({
                            start: index,
                            end: index + h.text.length,
                            highlight: h
                        });
                    }
                });

                highlightPositions.sort((a, b) => a.start - b.start);

                const parts = [];
                let lastIndex = 0;

                highlightPositions.forEach((pos, idx) => {
                    if (pos.start > lastIndex) {
                        parts.push(
                            <span key={`text-${idx}`}>{articleText.substring(lastIndex, pos.start)}</span>
                        );
                    }

                    const color = collaboratorColors[pos.highlight.collaboratorIndex];
                    parts.push(
                        <mark
                            key={`highlight-${idx}`}
                            className={`${color.highlight} ${color.text} px-1 rounded cursor-pointer transition hover:opacity-80`}
                            title={`${pos.highlight.collaboratorName}: ${pos.highlight.annotation || 'No note'}`}
                        >
                            {pos.highlight.text}
                        </mark>
                    );

                    lastIndex = pos.end;
                });

                if (lastIndex < articleText.length) {
                    parts.push(
                        <span key="text-final">{articleText.substring(lastIndex)}</span>
                    );
                }

                return <div className="whitespace-pre-line text-gray-800">{parts}</div>;
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
                    <div className="max-w-6xl mx-auto">
                        <h1 className="text-4xl font-bold text-indigo-900 mb-2 text-center">
                            Collaborative Highlight & Annotation Tool
                        </h1>
                        <p className="text-center text-indigo-700 mb-8">Work together to analyze articles and create summaries</p>

                        <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                            <div className="flex border-b overflow-x-auto">
                                <button
                                    onClick={() => setActiveTab('setup')}
                                    className={`flex-1 py-4 px-6 font-semibold transition whitespace-nowrap ${
                                        activeTab === 'setup' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    }`}
                                >
                                    <Users /> Setup
                                </button>
                                <button
                                    onClick={() => setActiveTab('learn')}
                                    className={`flex-1 py-4 px-6 font-semibold transition whitespace-nowrap ${
                                        activeTab === 'learn' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    }`}
                                >
                                    <BookOpen /> How to Highlight
                                </button>
                                <button
                                    onClick={() => articleText && setActiveTab('practice')}
                                    disabled={!articleText}
                                    className={`flex-1 py-4 px-6 font-semibold transition whitespace-nowrap ${
                                        activeTab === 'practice' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    } ${!articleText ? 'opacity-50 cursor-not-allowed' : ''}`}
                                >
                                    <Lightbulb /> Highlight
                                </button>
                                <button
                                    onClick={() => setActiveTab('summary')}
                                    disabled={Object.keys(allHighlights).every(k => !allHighlights[k] || allHighlights[k].length === 0)}
                                    className={`flex-1 py-4 px-6 font-semibold transition whitespace-nowrap ${
                                        activeTab === 'summary' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    } ${Object.keys(allHighlights).every(k => !allHighlights[k] || allHighlights[k].length === 0) ? 'opacity-50 cursor-not-allowed' : ''}`}
                                >
                                    <Sparkles /> Summary
                                </button>
                            </div>

                            <div className="p-8">
                                {activeTab === 'setup' && (
                                    <div>
                                        <h2 className="text-2xl font-bold text-gray-800 mb-6">Setup Your Collaboration</h2>
                                        
                                        <div className="mb-8 bg-indigo-50 border-l-4 border-indigo-600 p-4 rounded">
                                            <h3 className="font-semibold text-indigo-900 mb-2">How It Works:</h3>
                                            <ol className="text-indigo-800 space-y-1 text-sm list-decimal list-inside">
                                                <li>Choose number of collaborators (2-4)</li>
                                                <li>Upload or paste an article</li>
                                                <li>Each student highlights key points</li>
                                                <li>Generate collaborative summary</li>
                                            </ol>
                                            <div className="mt-3 pt-3 border-t border-indigo-200">
                                                <p className="text-sm text-indigo-700 flex items-center gap-2">
                                                    <CheckCircle size={16} />
                                                    <strong>Offline Mode:</strong> Work auto-saved!
                                                </p>
                                            </div>
                                        </div>

                                        <div className="mb-8">
                                            <h3 className="text-xl font-semibold text-gray-800 mb-4">Number of Collaborators</h3>
                                            <div className="flex gap-4">
                                                {[2, 3, 4].map(num => (
                                                    <button
                                                        key={num}
                                                        onClick={() => handleNumCollaboratorsChange(num)}
                                                        className={`px-6 py-3 rounded-lg font-semibold transition ${
                                                            numCollaborators === num ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                        }`}
                                                    >
                                                        {num} Students
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="mb-8">
                                            <h3 className="text-xl font-semibold text-gray-800 mb-4">Collaborator Names</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                {collaboratorNames.map((name, index) => (
                                                    <div key={index} className={`border-l-4 p-4 rounded ${collaboratorColors[index].bg} ${collaboratorColors[index].border}`}>
                                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                            Student {index + 1}
                                                        </label>
                                                        <input
                                                            type="text"
                                                            value={name}
                                                            onChange={(e) => handleCollaboratorNameChange(index, e.target.value)}
                                                            className="w-full p-2 border-2 border-gray-300 rounded focus:border-indigo-500 focus:outline-none"
                                                        />
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="border-t pt-8">
                                            <h3 className="text-xl font-semibold text-gray-800 mb-4">Upload Your Article</h3>
                                            
                                            <div className="mb-8">
                                                <div className="border-2 border-dashed border-indigo-300 rounded-lg p-12 text-center hover:border-indigo-400 transition">
                                                    <input
                                                        type="file"
                                                        accept=".txt,.pdf,.docx"
                                                        onChange={handleFileUpload}
                                                        className="hidden"
                                                        id="article-upload"
                                                    />
                                                    <label htmlFor="article-upload" className="cursor-pointer">
                                                        <FileText />
                                                        <p className="text-lg text-gray-700 mb-2 mt-4">Click to upload</p>
                                                        <p className="text-sm text-gray-500">.txt, .pdf, .docx</p>
                                                    </label>
                                                </div>
                                            </div>

                                            <div className="relative mb-8">
                                                <div className="absolute inset-0 flex items-center">
                                                    <div className="w-full border-t border-gray-300"></div>
                                                </div>
                                                <div className="relative flex justify-center text-sm">
                                                    <span className="px-4 bg-white text-gray-500 font-semibold">OR PASTE TEXT</span>
                                                </div>
                                            </div>

                                            <div>
                                                <input
                                                    type="text"
                                                    value={articleTitle}
                                                    onChange={(e) => setArticleTitle(e.target.value)}
                                                    placeholder="Article Title (optional)"
                                                    className="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 focus:border-indigo-500 focus:outline-none"
                                                />
                                                <textarea
                                                    value={pastedText}
                                                    onChange={(e) => setPastedText(e.target.value)}
                                                    placeholder="Paste article text here (min 100 chars)"
                                                    className="w-full h-64 p-4 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
                                                />
                                                <button
                                                    onClick={handleManualInput}
                                                    className="mt-4 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 font-semibold transition"
                                                >
                                                    Start Collaborating
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'learn' && (
                                    <div>
                                        <h2 className="text-2xl font-bold text-gray-800 mb-6">How to Highlight Effectively</h2>
                                        
                                        <div className="space-y-6">
                                            <div className="bg-indigo-50 rounded-lg p-6">
                                                <h3 className="text-xl font-semibold text-indigo-900 mb-3 flex items-center gap-2">
                                                    <CheckCircle size={24} />
                                                    Identify Main Ideas
                                                </h3>
                                                <p className="text-gray-700 leading-relaxed">Look for topic sentences, thesis statements, and concluding thoughts. These usually contain the author's key arguments.</p>
                                            </div>
                                            
                                            <div className="bg-indigo-50 rounded-lg p-6">
                                                <h3 className="text-xl font-semibold text-indigo-900 mb-3 flex items-center gap-2">
                                                    <CheckCircle size={24} />
                                                    Find Important Facts & Data
                                                </h3>
                                                <p className="text-gray-700 leading-relaxed">Highlight statistics, research findings, and specific evidence that support the main arguments.</p>
                                            </div>
                                            
                                            <div className="bg-indigo-50 rounded-lg p-6">
                                                <h3 className="text-xl font-semibold text-indigo-900 mb-3 flex items-center gap-2">
                                                    <CheckCircle size={24} />
                                                    Mark Key Terms & Definitions
                                                </h3>
                                                <p className="text-gray-700 leading-relaxed">New vocabulary and technical terms are important for understanding the subject matter.</p>
                                            </div>
                                            
                                            <div className="bg-indigo-50 rounded-lg p-6">
                                                <h3 className="text-xl font-semibold text-indigo-900 mb-3 flex items-center gap-2">
                                                    <CheckCircle size={24} />
                                                    Be Selective
                                                </h3>
                                                <p className="text-gray-700 leading-relaxed">Don't highlight everything! Aim to highlight 10-20% of the text. If you highlight too much, nothing stands out.</p>
                                            </div>
                                            
                                            <div className="bg-indigo-50 rounded-lg p-6">
                                                <h3 className="text-xl font-semibold text-indigo-900 mb-3 flex items-center gap-2">
                                                    <CheckCircle size={24} />
                                                    Add Your Own Notes
                                                </h3>
                                                <p className="text-gray-700 leading-relaxed">After highlighting, write brief annotations explaining why this point matters or how it connects to other ideas.</p>
                                            </div>
                                        </div>

                                        <div className="mt-8 bg-gradient-to-r from-green-100 to-blue-100 rounded-lg p-6">
                                            <h3 className="text-xl font-semibold text-gray-900 mb-4">What Makes a Good Highlight?</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div className="bg-white rounded p-4">
                                                    <h4 className="font-bold text-green-700 mb-2">✓ DO Highlight:</h4>
                                                    <ul className="text-sm text-gray-700 space-y-1">
                                                        <li>• Main arguments and thesis statements</li>
                                                        <li>• Important facts and statistics</li>
                                                        <li>• Key definitions and concepts</li>
                                                        <li>• Cause and effect relationships</li>
                                                        <li>• Conclusions and summaries</li>
                                                    </ul>
                                                </div>
                                                <div className="bg-white rounded p-4">
                                                    <h4 className="font-bold text-red-700 mb-2">✗ AVOID Highlighting:</h4>
                                                    <ul className="text-sm text-gray-700 space-y-1">
                                                        <li>• Minor examples or anecdotes</li>
                                                        <li>• Transitional phrases</li>
                                                        <li>• Repeated information</li>
                                                        <li>• Entire paragraphs at once</li>
                                                        <li>• Common knowledge facts</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="mt-8 bg-yellow-50 border-l-4 border-yellow-600 p-6 rounded">
                                            <h3 className="text-xl font-semibold text-yellow-900 mb-3">Collaboration Tips</h3>
                                            <ul className="text-gray-700 space-y-2">
                                                <li>• <strong>Communicate:</strong> Discuss what you're finding as you highlight</li>
                                                <li>• <strong>Don't duplicate:</strong> Try to find different key points than your teammates</li>
                                                <li>• <strong>Be thoughtful:</strong> Quality matters more than quantity</li>
                                                <li>• <strong>Add notes:</strong> Explain why your highlight is important</li>
                                                <li>• <strong>Review together:</strong> Look at the final summary as a team</li>
                                            </ul>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'practice' && articleText && (
                                    <div>
                                        <div className="mb-6 bg-indigo-50 border-l-4 border-indigo-600 p-4 rounded flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                            <div>
                                                <h3 className="font-semibold text-indigo-900 mb-1">Article: {articleTitle}</h3>
                                                <p className="text-indigo-800 text-sm">
                                                    Current: <strong>{collaboratorNames[currentCollaborator]}</strong>
                                                </p>
                                            </div>
                                            <button
                                                onClick={resetArticle}
                                                className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm whitespace-nowrap"
                                            >
                                                Reset All
                                            </button>
                                        </div>

                                        <div className="mb-6 flex flex-wrap gap-2">
                                            <span className="text-sm font-semibold text-gray-700 py-2">Switch:</span>
                                            {collaboratorNames.map((name, index) => (
                                                <button
                                                    key={index}
                                                    onClick={() => switchCollaborator(index)}
                                                    className={`px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2 ${
                                                        currentCollaborator === index ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                    }`}
                                                >
                                                    <span className={`w-4 h-4 rounded ${collaboratorColors[index].highlight}`}></span>
                                                    {name} ({(allHighlights[name] || []).length})
                                                </button>
                                            ))}
                                        </div>

                                        <div className="mb-4 bg-blue-50 border-l-4 border-blue-600 p-4 rounded">
                                            <h4 className="font-semibold text-blue-900 mb-2">Legend:</h4>
                                            <div className="flex flex-wrap gap-3">
                                                {collaboratorNames.map((name, index) => (
                                                    <span key={index} className={`px-3 py-1 rounded ${collaboratorColors[index].highlight} ${collaboratorColors[index].text} font-semibold`}>
                                                        {name}
                                                    </span>
                                                ))}
                                            </div>
                                            <p className="text-sm text-blue-800 mt-2">Hover over highlights to see notes!</p>
                                        </div>

                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                            <div>
                                                <h2 className="text-xl font-bold text-gray-800 mb-4">Article (all highlights shown)</h2>
                                                <div 
                                                    className="bg-gray-50 rounded-lg p-6 border-2 border-gray-200 leading-relaxed select-text cursor-text max-h-[600px] overflow-y-auto"
                                                    onMouseUp={handleTextSelection}
                                                    style={{ userSelect: 'text' }}
                                                >
                                                    {renderHighlightedText()}
                                                </div>
                                            </div>

                                            <div>
                                                <div className="flex justify-between items-center mb-4">
                                                    <h2 className="text-xl font-bold text-gray-800">
                                                        {collaboratorNames[currentCollaborator]}'s Highlights ({highlights.length})
                                                    </h2>
                                                    {highlights.length > 0 && (
                                                        <button
                                                            onClick={generateSummary}
                                                            className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center text-sm gap-2"
                                                        >
                                                            <Sparkles size={16} />
                                                            Summary
                                                        </button>
                                                    )}
                                                </div>

                                                {highlights.length === 0 ? (
                                                    <div className="bg-gray-50 rounded-lg p-8 text-center border-2 border-dashed border-gray-300">
                                                        <Lightbulb size={48} />
                                                        <p className="text-gray-600 font-semibold mb-2 mt-3">No highlights yet</p>
                                                        <p className="text-gray-500 text-sm">Select text to highlight!</p>
                                                    </div>
                                                ) : (
                                                    <div className="space-y-4 max-h-[600px] overflow-y-auto pr-2">
                                                        {highlights.map((highlight, index) => {
                                                            const highlightFeedback = feedback.find(f => f.id === highlight.id);
                                                            return (
                                                                <div
                                                                    key={highlight.id}
                                                                    className={`border-l-4 p-4 rounded ${
                                                                        highlightFeedback ? getFeedbackColor(highlightFeedback.type) : 'bg-gray-50 border-gray-500'
                                                                    }`}
                                                                >
                                                                    <div className="flex justify-between items-start mb-2">
                                                                        <span className="text-sm font-semibold text-gray-600">
                                                                            Highlight {index + 1}
                                                                        </span>
                                                                        <button
                                                                            onClick={() => removeHighlight(highlight.id)}
                                                                            className="text-red-600 hover:text-red-800 text-sm font-semibold"
                                                                        >
                                                                            Remove
                                                                        </button>
                                                                    </div>
                                                                    
                                                                    <p className="text-gray-800 mb-3 text-sm italic">
                                                                        "{highlight.text}"
                                                                    </p>

                                                                    {highlightFeedback && (
                                                                        <div className="flex items-start gap-2 mb-3 text-sm">
                                                                            {getFeedbackIcon(highlightFeedback.type)}
                                                                            <p className="text-gray-700">{highlightFeedback.message}</p>
                                                                        </div>
                                                                    )}

                                                                    <textarea
                                                                        value={highlight.annotation}
                                                                        onChange={(e) => updateAnnotation(highlight.id, e.target.value)}
                                                                        placeholder="Add notes: Why important?"
                                                                        className="w-full p-2 border border-gray-300 rounded text-sm focus:border-indigo-500 focus:outline-none"
                                                                        rows="2"
                                                                    />
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'summary' && (
                                    <div>
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="text-2xl font-bold text-gray-800">Collaborative Summary</h2>
                                            {compiledSummary && (
                                                <button
                                                    onClick={exportSummary}
                                                    className="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 flex items-center gap-2"
                                                >
                                                    <Download size={18} />
                                                    Export
                                                </button>
                                            )}
                                        </div>

                                        {!compiledSummary ? (
                                            <div className="text-center py-12">
                                                <button
                                                    onClick={generateSummary}
                                                    className="bg-green-600 text-white px-8 py-4 rounded-lg hover:bg-green-700 flex items-center mx-auto text-lg font-semibold gap-3"
                                                >
                                                    <Sparkles size={24} />
                                                    Generate Summary
                                                </button>
                                                <p className="text-gray-600 mt-4">
                                                    Combine all highlights into one summary
                                                </p>
                                            </div>
                                        ) : (
                                            <div>
                                                <div className="bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-300 rounded-lg p-6 mb-6">
                                                    <h3 className="text-xl font-semibold text-gray-900 mb-2 flex items-center gap-2">
                                                        <CheckCircle size={24} />
                                                        Summary Generated!
                                                    </h3>
                                                    <p className="text-gray-700">
                                                        Combined insights from {numCollaborators} collaborators
                                                    </p>
                                                </div>

                                                <div className="bg-white border-2 border-gray-300 rounded-lg p-6 mb-6">
                                                    <pre className="whitespace-pre-wrap font-mono text-sm text-gray-800 leading-relaxed">
                                                        {compiledSummary}
                                                    </pre>
                                                </div>

                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div className="bg-blue-50 border-l-4 border-blue-600 p-4 rounded">
                                                        <h4 className="font-semibold text-blue-900 mb-2">Total Highlights</h4>
                                                        <p className="text-3xl font-bold text-blue-700">
                                                            {Object.values(allHighlights).reduce((sum, arr) => sum + arr.length, 0)}
                                                        </p>
                                                    </div>
                                                    <div className="bg-purple-50 border-l-4 border-purple-600 p-4 rounded">
                                                        <h4 className="font-semibold text-purple-900 mb-2">Collaborators</h4>
                                                        <p className="text-3xl font-bold text-purple-700">{numCollaborators}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<PDFHighlightTool />, document.getElementById('root'));
    </script>
</body>
</html>
